---
title: "Title"
author: "Christian Oppegård Moen"
date: "DD MM YYYY"
output: 
  bookdown::pdf_document2:
    toc_depth: '3'
    number_sections: false
  # pdf_document:
  # #   toc: no
  #   toc_depth: '3'
subtitle: Course
urlcolor: blue
editor_options: 
  chunk_output_type: console
header-includes:
- \usepackage[width=0.8\textwidth]{caption}
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = T, tidy=T, message=F, warning=F,
  strip.white=F,
  prompt=F,
  cache=T,
  # root.dir = "./subfolder",
  size="scriptsize",
  fig.width=7, 
  fig.height=5, 
  fig.align = "center"
)
```

```{r config, include=F}
if (F){
  setwd("C:/Users/chris/OneDrive/Documents/Fysmat/8 Semester V2022/RomStat/romstat/project3/")
  options(error=recover)
  options(error=NULL)
}
source("resources/functions.R")
load("resources/Admin1Geography.RData")
fig.path = "figures/"
```

```{r packages, options}
library(logitnorm)
```

# a) Display observations
**Display the observed proportions (i.e., pˆa, and not ya) on the Nigeria map. Discuss whether borrowing strength in space to reduce uncertainty seems reasonable.**

```{r adisplay, options}
invLogit = function(x) {
  exp(x)/(exp(x) + 1)
}

dirEst = read.table("resources/DirectEstimates.txt", header = T)
leg = " "
# cs.v = c(0,0.2)
p.hat = invLogit(dirEst$Observation)
V = dirEst$StdDev^2
cs.p = c(0,1)
# cs.p = c(range(p.hat))
cs.v = range(V)

plotAreaCol(paste0(fig.path, "vacc_cov_obs.pdf"),
            20,20,p.hat,nigeriaAdm1,"Proportion vaccinated",cs.p)
plotAreaCol(paste0(fig.path, "vacc_cov_var.pdf"),
            20,20,V,nigeriaAdm1,"Variance",cs.v)
```

# b) Conditional distr.
**Compute median and the coeff. of variation for $P_a|Y=y$ empirically based on 100 samples**
```{r 2bEmpiricPa, options}
set.seed(321)
n = length(V)
sigma=100
y = dirEst$Observation
Y = rnorm(y,sqrt(V))
# sigma=V
# V = 100
Q_YX = 1/diag(V)
Q_X = diag(1/sigma^2, nrow = n, ncol = n)

mu_XY = diag(1/sigma^2* V + 1 + y)
Q_XY =  Q_X + Q_YX

sim.uncond = function(mu, Q, N=100){
  L = sqrt(diag(Q))
  n = length(mu)
  x.mat = matrix(nrow = n, ncol = N)
  for (i in 1:100){
    z = rnorm(n)
    v = z/L
    x.mat[,i] = mu + v
  }
  return(x.mat)
}

x.mat = sim.uncond(mu_XY, Q_XY)
p.star.mat = invLogit(x.mat)
p.star.median = apply(p.star.mat,1,median)
v.star = apply(p.star.mat, 1, var)
# p.star.median
# v.star

```
**display them in two maps of Nigeria.**
```{r 2bDisplay, options}
plotAreaCol(paste0(fig.path, "2b_median.pdf"),
            20,20,p.star.median,nigeriaAdm1,"Median",cs.p)
plotAreaCol(paste0(fig.path, "2b_var.pdf"),
            20,20,v.star,nigeriaAdm1,"Variance",range(v.star))
```